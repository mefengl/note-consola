/**
 * ğŸ—ºï¸ é”™è¯¯åœ°å€æ•´ç†å·¥å…·
 * 
 * æƒ³è±¡è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªåœ°å€æ•´ç†å‘˜ï¼š
 * - æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæ”¶åˆ°å¾ˆé•¿å¾ˆä¹±çš„åœ°å€ï¼ˆé”™è¯¯å †æ ˆï¼‰
 * - è¿™äº›åœ°å€å¤ªé•¿äº†ï¼Œä¸å¥½çœ‹
 * - æˆ‘ä»¬è¦æŠŠå®ƒä»¬æ•´ç†å¾—ç®€å•ä¸€ç‚¹
 */

import { sep } from "node:path";

/**
 * ğŸ“ æ•´ç†é”™è¯¯å †æ ˆ
 * å°±åƒæ•´ç†ä¸€å †æ··ä¹±çš„åœ°å€ï¼š
 * 
 * æ¯”å¦‚æŠŠè¿™æ ·çš„åœ°å€ï¼š
 * "file:///home/user/projects/my-app/src/index.ts"
 * 
 * æ•´ç†æˆè¿™æ ·ï¼š
 * "src/index.ts"
 * 
 * æ•´ç†æ­¥éª¤ï¼š
 * 1. æŠŠåœ°å€åˆ†æˆä¸€è¡Œä¸€è¡Œçš„
 * 2. å»æ‰ç¬¬ä¸€è¡Œï¼ˆå› ä¸ºå®ƒæ˜¯é”™è¯¯ä¿¡æ¯ï¼‰
 * 3. å»æ‰æ¯è¡Œå¼€å¤´å’Œç»“å°¾çš„ç©ºæ ¼
 * 4. å»æ‰"file://"è¿™ä¸ªå‰ç¼€
 * 5. å»æ‰å½“å‰æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„
 * 
 * @param stack åŸå§‹çš„é”™è¯¯å †æ ˆï¼ˆåƒä¸€å †æ··ä¹±çš„åœ°å€ï¼‰
 * @returns æ•´ç†å¥½çš„åœ°å€åˆ—è¡¨
 */
export function parseStack(stack: string) {
  // è·å–å½“å‰å·¥ä½œç›®å½•ï¼ˆåƒè·å–æˆ‘ä»¬æ‰€åœ¨çš„åŸå¸‚ï¼‰
  const cwd = process.cwd() + sep;

  // å¼€å§‹æ•´ç†åœ°å€
  const lines = stack
    .split("\n")                    // æŠŠåœ°å€åˆ†æˆä¸€è¡Œä¸€è¡Œçš„
    .splice(1)                      // å»æ‰ç¬¬ä¸€è¡Œ
    .map((l) => l
      .trim()                       // å»æ‰å¤šä½™çš„ç©ºæ ¼
      .replace("file://", "")       // å»æ‰"file://"
      .replace(cwd, "")            // å»æ‰å½“å‰ç›®å½•è·¯å¾„
    );

  return lines;
}
